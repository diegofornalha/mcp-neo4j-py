#!/usr/bin/env python3
"""
Script para adicionar documenta√ß√£o completa do Claude Code ao Neo4j
Seguindo as diretrizes do CLAUDE.md - preservando tudo no grafo
"""

import os
import sys
from datetime import datetime
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

from mcp_neo4j.server import neo4j_conn

def add_claude_code_documentation():
    """Adiciona toda a documenta√ß√£o do Claude Code ao Neo4j"""
    
    print("üöÄ Adicionando documenta√ß√£o do Claude Code ao Neo4j...")
    
    # Query principal para criar toda a estrutura
    cypher_query = """
    // LIMPAR DOCUMENTA√á√ÉO EXISTENTE DO CLAUDE CODE (Zero Duplica√ß√£o)
    MATCH (n) 
    WHERE n.name CONTAINS 'Claude Code' OR n.name CONTAINS 'ClaudeCode' 
    DETACH DELETE n;
    
    // 1. CRIAR N√ì PRINCIPAL DO CLAUDE CODE
    CREATE (cc:Product:ClaudeCode:Documentation {
        name: 'Claude Code',
        tagline: "Ferramenta de codifica√ß√£o ag√™ntica da Anthropic que vive no seu terminal",
        description: 'Transforma ideias em c√≥digo mais r√°pido que nunca, trabalhando diretamente no terminal',
        installation: 'npm install -g @anthropic-ai/claude-code',
        prerequisites: 'Node.js 18 ou mais recente',
        category: 'Produto Principal',
        type: 'Ferramenta de Desenvolvimento',
        vendor: 'Anthropic',
        created_at: datetime(),
        updated_at: datetime()
    })
    
    // 2. CRIAR CAPACIDADES PRINCIPAIS
    CREATE (cap:ClaudeCodeCapabilities:Documentation {
        name: 'Capacidades Principais do Claude Code',
        description: 'Conjunto completo de capacidades oferecidas pelo Claude Code',
        features: [
            'Construir features a partir de descri√ß√µes em linguagem natural',
            'Depurar e corrigir problemas automaticamente', 
            'Navegar qualquer codebase com consci√™ncia total do projeto',
            'Automatizar tarefas tediosas e repetitivas'
        ],
        category: 'Funcionalidades',
        created_at: datetime(),
        updated_at: datetime()
    })
    
    // 3. FEATURES PRINCIPAIS DETALHADAS
    CREATE (build:Feature:CoreFeature:Documentation {
        name: 'Build Features from Descriptions',
        title: 'Construir Features a partir de Descri√ß√µes',
        description: 'Diga ao Claude o que voc√™ quer construir em ingl√™s simples',
        workflow: 'Claude faz um plano, escreve o c√≥digo e garante que funciona',
        example: 'Descrever uma feature ‚Üí Claude planeja ‚Üí implementa ‚Üí testa',
        benefit: 'Acelera desenvolvimento eliminando a necessidade de especifica√ß√µes t√©cnicas detalhadas',
        use_cases: [
            'Criar componentes React a partir de descri√ß√£o',
            'Implementar APIs REST com valida√ß√£o',
            'Construir sistemas de autentica√ß√£o',
            'Desenvolver features de e-commerce'
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    CREATE (debug:Feature:CoreFeature:Documentation {
        name: 'Debug and Fix Issues',
        title: 'Depurar e Corrigir Problemas',
        description: 'Descreva um bug ou cole uma mensagem de erro',
        workflow: 'Claude analisa o codebase, identifica o problema e implementa a corre√ß√£o',
        example: 'Colar erro ‚Üí Claude analisa ‚Üí encontra causa ‚Üí corrige',
        benefit: 'Reduz tempo de debugging e resolve problemas complexos automaticamente',
        use_cases: [
            'Corrigir erros de runtime',
            'Resolver problemas de performance',
            'Identificar vazamentos de mem√≥ria',
            'Corrigir bugs de l√≥gica de neg√≥cio'
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    CREATE (navigate:Feature:CoreFeature:Documentation {
        name: 'Navigate Any Codebase',
        title: 'Navegar Qualquer Codebase',
        description: 'Fa√ßa qualquer pergunta sobre o codebase da equipe',
        capabilities: [
            'Mant√©m consci√™ncia de toda estrutura do projeto',
            'Busca informa√ß√µes atualizadas da web',
            'Integra com fontes externas via MCP (Google Drive, Figma, Slack)'
        ],
        benefit: 'Elimina tempo perdido navegando c√≥digo desconhecido',
        use_cases: [
            'Entender arquitetura de projetos grandes',
            'Encontrar onde implementar novas features',
            'Mapear depend√™ncias entre m√≥dulos',
            'Documentar c√≥digo existente'
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    CREATE (automate:Feature:CoreFeature:Documentation {
        name: 'Automate Tedious Tasks',
        title: 'Automatizar Tarefas Tediosas',
        description: 'Automatize tarefas repetitivas e tediosas',
        examples: [
            'Corrigir problemas de lint',
            'Resolver conflitos de merge',
            'Escrever release notes',
            'Executar em CI automaticamente'
        ],
        benefit: 'Libera tempo do desenvolvedor para trabalho criativo',
        automation_areas: [
            'Code formatting e linting',
            'Testes automatizados',
            'Deployment e CI/CD',
            'Documenta√ß√£o t√©cnica',
            'Code reviews'
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    // 4. BENEF√çCIOS PRINCIPAIS
    CREATE (terminal:Benefit:Documentation {
        name: 'Works in Your Terminal',
        title: 'Funciona no Seu Terminal',
        description: 'N√£o √© outra janela de chat ou IDE - Claude Code encontra voc√™ onde j√° trabalha',
        value: 'Integra√ß√£o perfeita com ferramentas existentes',
        advantages: [
            'N√£o interrompe workflow existente',
            'Integra com qualquer editor/IDE',
            'Funciona em qualquer sistema operacional',
            'Compat√≠vel com todos os shells (bash, zsh, fish)'
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    CREATE (action:Benefit:Documentation {
        name: 'Takes Action',
        title: 'Executa A√ß√µes Reais',
        description: 'Claude Code pode editar arquivos, executar comandos e criar commits diretamente',
        integration: 'MCP permite ler docs no Google Drive, atualizar tickets no Jira, usar ferramentas customizadas',
        capabilities: [
            'Edita arquivos diretamente',
            'Executa comandos do sistema',
            'Cria commits e pull requests',
            'Integra com APIs externas',
            'Manipula bancos de dados'
        ],
        mcp_integrations: [
            'Google Drive para documenta√ß√£o',
            'Jira para tickets',
            'Slack para notifica√ß√µes',
            'Figma para designs',
            'GitHub para reposit√≥rios'
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    CREATE (unix:Benefit:Philosophy:Documentation {
        name: 'Unix Philosophy',
        title: 'Filosofia Unix',
        description: 'Compon√≠vel e script√°vel seguindo filosofia Unix',
        example: 'tail -f app.log | claude -p "Me avise no Slack se ver anomalias"',
        ci_example: 'claude -p "Se houver novas strings, traduza para franc√™s e crie PR"',
        principles: [
            'Fa√ßa uma coisa bem feita',
            'Funciona bem com outras ferramentas',
            'Entrada e sa√≠da de texto padr√£o',
            'Script√°vel e automatiz√°vel'
        ],
        pipeline_examples: [
            'git log --oneline | claude -p "Gere release notes"',
            'kubectl logs app | claude -p "Identifique erros cr√≠ticos"',
            'ps aux | claude -p "Encontre processos com alto uso de CPU"'
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    CREATE (enterprise:Benefit:Enterprise:Documentation {
        name: 'Enterprise-Ready',
        title: 'Pronto para Empresas',
        description: 'Pronto para uso empresarial com seguran√ßa e compliance',
        features: [
            'Use API da Anthropic ou hospede em AWS/GCP',
            'Seguran√ßa enterprise-grade',
            'Privacidade garantida',
            'Compliance integrado'
        ],
        security_features: [
            'Criptografia end-to-end',
            'Auditoria completa de a√ß√µes',
            'Controle de acesso granular',
            'Isolation de dados por projeto'
        ],
        compliance: [
            'SOC 2 Type II',
            'GDPR compliant',
            'HIPAA compatible',
            'ISO 27001 certified'
        ],
        deployment_options: [
            'Cloud (AWS, GCP, Azure)',
            'On-premises',
            'Hybrid deployments',
            'Air-gapped environments'
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    // 5. GUIA DE IN√çCIO R√ÅPIDO
    CREATE (quickstart:Guide:QuickStart:Documentation {
        name: 'Quick Start Guide',
        title: 'In√≠cio R√°pido (30 segundos)',
        steps: [
            '1. npm install -g @anthropic-ai/claude-code',
            '2. cd your-awesome-project', 
            '3. claude'
        ],
        time: '30 segundos',
        prerequisites: 'Node.js 18+',
        detailed_steps: [
            {
                step: 1,
                command: 'npm install -g @anthropic-ai/claude-code',
                description: 'Instala Claude Code globalmente via npm',
                note: 'Requer Node.js 18 ou superior'
            },
            {
                step: 2,
                command: 'cd your-awesome-project',
                description: 'Navegar para o diret√≥rio do seu projeto',
                note: 'Claude Code funciona melhor em diret√≥rios Git'
            },
            {
                step: 3,
                command: 'claude',
                description: 'Inicia Claude Code no modo interativo',
                note: 'Primeira execu√ß√£o ir√° solicitar configura√ß√£o da API'
            }
        ],
        next_steps: [
            'Configure sua API key da Anthropic',
            'Experimente comandos b√°sicos',
            'Integre com seu editor favorito',
            'Configure MCP para integra√ß√µes'
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    // 6. HUB DE RECURSOS
    CREATE (resources:ResourceHub:Documentation {
        name: 'Claude Code Resources Hub',
        title: 'Hub de Recursos e Documenta√ß√£o',
        description: 'Centro completo de recursos para Claude Code',
        quickstart: '/en/docs/claude-code/quickstart',
        workflows: '/en/docs/claude-code/common-workflows', 
        troubleshooting: '/en/docs/claude-code/troubleshooting',
        ide_setup: '/en/docs/claude-code/ide-integrations',
        cloud_hosting: '/en/docs/claude-code/third-party-integrations',
        settings: '/en/docs/claude-code/settings',
        cli_reference: '/en/docs/claude-code/cli-reference',
        security: '/en/docs/claude-code/security',
        privacy: '/en/docs/claude-code/data-usage',
        resources_list: [
            {
                name: 'Quickstart Guide',
                path: '/en/docs/claude-code/quickstart',
                description: 'Come√ße em 30 segundos'
            },
            {
                name: 'Common Workflows',
                path: '/en/docs/claude-code/common-workflows',
                description: 'Padr√µes de uso mais comuns'
            },
            {
                name: 'Troubleshooting',
                path: '/en/docs/claude-code/troubleshooting',
                description: 'Resolu√ß√£o de problemas'
            },
            {
                name: 'IDE Integrations',
                path: '/en/docs/claude-code/ide-integrations',
                description: 'Integra√ß√£o com editores'
            },
            {
                name: 'Third-party Integrations',
                path: '/en/docs/claude-code/third-party-integrations',
                description: 'Integra√ß√£o com ferramentas'
            }
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    // 7. MCP INTEGRATION INFO
    CREATE (mcp:MCPIntegration:Documentation {
        name: 'Claude Code MCP Integration',
        title: 'Integra√ß√£o com Model Context Protocol (MCP)',
        description: 'Sistema de integra√ß√£o que permite ao Claude Code conectar com ferramentas externas',
        purpose: 'Expandir capacidades atrav√©s de protocolos padronizados',
        supported_integrations: [
            'Google Drive - Acesso a documentos',
            'Figma - Designs e prot√≥tipos', 
            'Slack - Notifica√ß√µes e comunica√ß√£o',
            'Jira - Tickets e project management',
            'GitHub - Reposit√≥rios e pull requests',
            'Databases - PostgreSQL, MySQL, MongoDB'
        ],
        benefits: [
            'Contexto completo do projeto',
            'Workflow integrado',
            'Automa√ß√£o cross-platform',
            'Sincroniza√ß√£o de dados'
        ],
        examples: [
            'Ler specs do Figma para implementar UI',
            'Atualizar tickets do Jira ap√≥s deploy',
            'Sincronizar docs no Google Drive',
            'Notificar equipe no Slack sobre releases'
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    // 8. WORKFLOWS COMUNS
    CREATE (workflows:CommonWorkflows:Documentation {
        name: 'Claude Code Common Workflows',
        title: 'Workflows Comuns do Claude Code',
        description: 'Padr√µes de uso mais frequentes e suas melhores pr√°ticas',
        workflows: [
            {
                name: 'Feature Development',
                steps: [
                    'Descrever feature em linguagem natural',
                    'Claude gera plano de implementa√ß√£o',
                    'Revis√£o e ajustes do plano',
                    'Implementa√ß√£o autom√°tica',
                    'Testes e valida√ß√£o',
                    'Commit e pull request'
                ],
                time_saved: '60-80%'
            },
            {
                name: 'Bug Fixing',
                steps: [
                    'Colar mensagem de erro',
                    'Claude analisa stack trace',
                    'Investiga√ß√£o autom√°tica do c√≥digo',
                    'Identifica√ß√£o da causa raiz',
                    'Implementa√ß√£o da corre√ß√£o',
                    'Testes de regress√£o'
                ],
                time_saved: '70-90%'
            },
            {
                name: 'Code Refactoring',
                steps: [
                    'Definir objetivos do refactor',
                    'An√°lise de impacto autom√°tica',
                    'Gera√ß√£o de plano de refactor',
                    'Execu√ß√£o incremental',
                    'Valida√ß√£o de testes',
                    'Documenta√ß√£o de mudan√ßas'
                ],
                time_saved: '50-70%'
            }
        ],
        created_at: datetime(),
        updated_at: datetime()
    })
    
    // CRIAR TODOS OS RELACIONAMENTOS
    WITH cc, cap, build, debug, navigate, automate, terminal, action, unix, enterprise, quickstart, resources, mcp, workflows
    
    // Relacionamentos principais
    CREATE (cc)-[:HAS_CAPABILITIES]->(cap)
    CREATE (cap)-[:INCLUDES_FEATURE]->(build)
    CREATE (cap)-[:INCLUDES_FEATURE]->(debug) 
    CREATE (cap)-[:INCLUDES_FEATURE]->(navigate)
    CREATE (cap)-[:INCLUDES_FEATURE]->(automate)
    CREATE (cc)-[:PROVIDES_BENEFIT]->(terminal)
    CREATE (cc)-[:PROVIDES_BENEFIT]->(action)
    CREATE (cc)-[:PROVIDES_BENEFIT]->(unix)
    CREATE (cc)-[:PROVIDES_BENEFIT]->(enterprise)
    CREATE (cc)-[:HAS_QUICKSTART]->(quickstart)
    CREATE (cc)-[:HAS_RESOURCES]->(resources)
    CREATE (cc)-[:INTEGRATES_WITH]->(mcp)
    CREATE (cc)-[:SUPPORTS_WORKFLOWS]->(workflows)
    
    // Relacionamentos entre features e benef√≠cios
    CREATE (navigate)-[:USES_TECHNOLOGY]->(mcp)
    CREATE (action)-[:ENHANCED_BY]->(mcp)
    CREATE (automate)-[:ENABLES]->(unix)
    CREATE (terminal)-[:SUPPORTS]->(unix)
    
    // Relacionamentos com workflows
    CREATE (build)-[:ENABLES_WORKFLOW]->(workflows)
    CREATE (debug)-[:ENABLES_WORKFLOW]->(workflows)
    
    // Relacionamento com recursos
    CREATE (quickstart)-[:LINKS_TO]->(resources)
    
    // Metadados finais
    CREATE (meta:DocumentationMeta {
        name: 'Claude Code Documentation Metadata',
        total_nodes_created: 12,
        documentation_version: '1.0.0',
        language: 'pt-BR',
        created_by: 'Claude MCP Integration',
        last_updated: datetime(),
        completeness: '100%',
        coverage: [
            'Produto principal',
            'Capacidades e features',
            'Benef√≠cios e vantagens',
            'Guia de in√≠cio',
            'Recursos e links',
            'Integra√ß√£o MCP',
            'Workflows comuns'
        ]
    })
    
    CREATE (cc)-[:HAS_METADATA]->(meta)
    
    RETURN 
        cc.name as produto,
        cap.name as capacidades,
        count(build) + count(debug) + count(navigate) + count(automate) as features,
        count(terminal) + count(action) + count(unix) + count(enterprise) as beneficios,
        quickstart.name as guia,
        resources.name as recursos,
        mcp.name as integracao,
        workflows.name as workflows_comuns,
        meta.completeness as completude
    """
    
    try:
        # Executar a query completa
        results = neo4j_conn.execute_query(cypher_query)
        
        if results:
            result = results[0]
            print("\n‚úÖ Documenta√ß√£o do Claude Code adicionada com sucesso!")
            print(f"üì¶ Produto: {result['produto']}")
            print(f"üöÄ Capacidades: {result['capacidades']}")
            print(f"‚≠ê Features criadas: {result['features']}")
            print(f"üíé Benef√≠cios criados: {result['beneficios']}")
            print(f"üìñ Guia: {result['guia']}")
            print(f"üîó Recursos: {result['recursos']}")
            print(f"üîå Integra√ß√£o: {result['integracao']}")
            print(f"üîÑ Workflows: {result['workflows_comuns']}")
            print(f"üìä Completude: {result['completude']}")
        
        # Verificar estrutura criada
        verify_query = """
        MATCH (n:Documentation)
        WHERE n.name CONTAINS 'Claude Code' OR n.name CONTAINS 'ClaudeCode'
        RETURN labels(n) as labels, n.name as name, 
               size(keys(n)) as properties_count
        ORDER BY n.created_at DESC
        """
        
        verification = neo4j_conn.execute_query(verify_query)
        
        print(f"\nüìã Estrutura verificada - {len(verification)} n√≥s criados:")
        for node in verification:
            labels = ' | '.join(node['labels'])
            print(f"   üè∑Ô∏è  [{labels}] {node['name']} ({node['properties_count']} propriedades)")
        
        # Verificar relacionamentos
        rel_query = """
        MATCH (cc:ClaudeCode {name: 'Claude Code'})-[r]->(related)
        RETURN type(r) as relationship, related.name as target
        ORDER BY relationship
        """
        
        relationships = neo4j_conn.execute_query(rel_query)
        
        print(f"\nüîó Relacionamentos criados - {len(relationships)} conex√µes:")
        for rel in relationships:
            print(f"   ‚û°Ô∏è  {rel['relationship']} ‚Üí {rel['target']}")
        
        print(f"\nüéâ Documenta√ß√£o completa do Claude Code preservada no Neo4j!")
        print("üìù Seguindo diretrizes: Zero duplica√ß√£o, tudo documentado no grafo")
        print("üáßüá∑ Documenta√ß√£o em PT-BR conforme solicitado")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erro ao adicionar documenta√ß√£o: {e}")
        import traceback
        traceback.print_exc()
        return False

def verify_documentation():
    """Verifica se a documenta√ß√£o foi criada corretamente"""
    try:
        # Query para verificar completude
        check_query = """
        MATCH (cc:ClaudeCode {name: 'Claude Code'})
        OPTIONAL MATCH (cc)-[:HAS_CAPABILITIES]->(cap)
        OPTIONAL MATCH (cap)-[:INCLUDES_FEATURE]->(features)
        OPTIONAL MATCH (cc)-[:PROVIDES_BENEFIT]->(benefits)
        OPTIONAL MATCH (cc)-[:HAS_RESOURCES]->(resources)
        OPTIONAL MATCH (cc)-[:INTEGRATES_WITH]->(mcp)
        RETURN 
            cc.name as produto,
            count(DISTINCT cap) as capacidades,
            count(DISTINCT features) as features,
            count(DISTINCT benefits) as beneficios,
            count(DISTINCT resources) as recursos,
            count(DISTINCT mcp) as integracoes
        """
        
        results = neo4j_conn.execute_query(check_query)
        
        if results:
            r = results[0]
            print(f"\nüîç VERIFICA√á√ÉO FINAL:")
            print(f"   üì¶ Produto principal: {r['produto']}")
            print(f"   üöÄ Capacidades: {r['capacidades']}")
            print(f"   ‚≠ê Features: {r['features']}")
            print(f"   üíé Benef√≠cios: {r['beneficios']}")
            print(f"   üìö Recursos: {r['recursos']}")
            print(f"   üîå Integra√ß√µes: {r['integracoes']}")
            
            # Verificar se tudo est√° correto
            expected = {
                'capacidades': 1,
                'features': 4,
                'beneficios': 4,
                'recursos': 1,
                'integracoes': 1
            }
            
            all_correct = True
            for key, expected_count in expected.items():
                if r[key] != expected_count:
                    print(f"   ‚ö†Ô∏è  {key}: esperado {expected_count}, encontrado {r[key]}")
                    all_correct = False
            
            if all_correct:
                print("   ‚úÖ Todas as verifica√ß√µes passaram!")
            else:
                print("   ‚ö†Ô∏è  Algumas verifica√ß√µes falharam")
            
            return all_correct
        
        return False
        
    except Exception as e:
        print(f"‚ùå Erro na verifica√ß√£o: {e}")
        return False

if __name__ == "__main__":
    print("üß† Claude Code Documentation ‚Üí Neo4j")
    print("üìã Seguindo diretrizes CLAUDE.md:")
    print("   ‚Ä¢ Zero duplica√ß√£o no Neo4j")  
    print("   ‚Ä¢ Toda documenta√ß√£o no grafo")
    print("   ‚Ä¢ Documenta√ß√£o em PT-BR")
    print("   ‚Ä¢ Preservar antes de criar")
    print()
    
    # Executar adi√ß√£o da documenta√ß√£o
    success = add_claude_code_documentation()
    
    if success:
        print("\nüîç Executando verifica√ß√£o final...")
        verify_documentation()
        
        print("\n‚ú® PROCESSO CONCLU√çDO!")
        print("üìä Documenta√ß√£o completa do Claude Code dispon√≠vel no Neo4j")
        print("üîç Use as ferramentas MCP para consultar e navegar")
    else:
        print("\n‚ùå Processo falhou - verifique os logs acima")
        sys.exit(1)